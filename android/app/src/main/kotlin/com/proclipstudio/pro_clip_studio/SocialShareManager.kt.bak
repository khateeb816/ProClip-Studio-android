package com.proclipstudio.pro_clip_studio

import android.app.Activity
import android.content.Context
import android.content.Intent
import android.net.Uri
import android.widget.Toast
import androidx.core.content.FileProvider
import java.io.File

/**
 * MANAGING SOCIAL MEDIA UPLOADS
 * 
 * Handles strict intent generation for TikTok, Instagram, and System Share.
 * Ensures FileProvider compliance and temporary permission grants.
 */
class SocialShareManager(private val context: Context) {

    companion object {
        private const val PKG_TIKTOK = "com.zhiliaoapp.musically"
        private const val PKG_TIKTOK_GLOBAL = "com.ss.android.ugc.trill"
        private const val PKG_INSTAGRAM = "com.instagram.android"
        private const val MIME_Video = "video/mp4"
    }

    /**
     * Share video to TikTok.
     * Tries Global package first, then Regional, then falls back to System if not installed.
     */
    fun shareToTikTok(filePath: String) {
        val file = File(filePath)
        if (!validateFile(file)) return
        
        val uri = getUriForFile(file)
        
        // Try specific packages
        if (!launchIntent(uri, PKG_TIKTOK_GLOBAL) && !launchIntent(uri, PKG_TIKTOK)) {
            // Fallback: System Share with title hint?
            // Or toast "TikTok not installed"
            shareToSystem(filePath, "Share to TikTok")
        }
    }

    /**
     * Share video to Instagram (Feed/Reels).
     * Instagram handles "video/*" intents by opening the post creator.
     */
    fun shareToInstagram(filePath: String) {
         val file = File(filePath)
         if (!validateFile(file)) return
         
         val uri = getUriForFile(file)
         
         if (!launchIntent(uri, PKG_INSTAGRAM)) {
             shareToSystem(filePath, "Share to Instagram")
         }
    }

    /**
     * Generic System Share Sheet
     */
    fun shareToSystem(filePath: String, title: String = "Share Video") {
        val file = File(filePath)
        if (!validateFile(file)) return
        
        val uri = getUriForFile(file)
        
        val intent = Intent(Intent.ACTION_SEND).apply {
            type = MIME_Video
            putExtra(Intent.EXTRA_STREAM, uri)
            addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
        }
        
        val chooser = Intent.createChooser(intent, title)
        chooser.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
        context.startActivity(chooser)
    }

    private fun launchIntent(uri: Uri, packageName: String): Boolean {
        try {
            val intent = Intent(Intent.ACTION_SEND).apply {
                type = MIME_Video
                putExtra(Intent.EXTRA_STREAM, uri)
                setPackage(packageName)
                addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                // TikTok sometimes requires specific components, but ACTION_SEND is standard.
            }
            
            // Verify if app exists
            val activities = context.packageManager.queryIntentActivities(intent, 0)
            if (activities.isNotEmpty()) {
                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                context.startActivity(intent)
                return true
            }
        } catch (e: Exception) {
            e.printStackTrace()
        }
        return false
    }

    private fun getUriForFile(file: File): Uri {
        return FileProvider.getUriForFile(
            context,
            "${context.packageName}.fileprovider",
            file
        )
    }

    private fun validateFile(file: File): Boolean {
        if (!file.exists() || file.length() == 0L) {
            Toast.makeText(context, "Export failed: File not found", Toast.LENGTH_SHORT).show()
            return false
        }
        return true
    }
}
